version: '3.8'

services:
  # 1. De Database Service (Postgres)
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      # Deze variabelen komen rechtstreeks uit je .env bestand
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      # Handig om met een DB-tool (bv. DBeaver) te kunnen kijken
      - "5432:5432"
    volumes:
      # Dit zorgt dat je data bewaard blijft, zelfs als je de container stopt
      - postgres_data:/var/lib/postgresql/data
      # Dit koppelt je init-script om de tabel aan te maken
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql

  # 2. De API Service (Express)
  api:
    # 'build: ./api' vertelt Docker om de 'Dockerfile' in de 'api' map te bouwen
    build: ./api
    restart: always
    ports:
      # Map de API-poort (bv. 3000) van de container naar je pc
      - "${API_PORT}:${API_PORT}"
    environment:
      # Geef de .env variabelen door aan de API container
      PORT: ${API_PORT}
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: ${POSTGRES_DB}
      # Dit is hoe de API de database-container vindt: via de servicenaam 'db'
      DB_HOST: db
    depends_on:
      # Zorg ervoor dat de 'db' service volledig is opgestart
      # voordat de 'api' service start.
      - db

# Definieer hier het 'named volume' dat we bij de 'db' service gebruikten
volumes:
  postgres_data: